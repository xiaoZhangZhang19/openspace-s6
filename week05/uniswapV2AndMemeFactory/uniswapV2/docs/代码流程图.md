# Uniswap V2 代码流程图

## 添加流动性流程

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  用户批准Router    |---->|  调用addLiquidity    |---->| Router检查交易对是否 |
|  使用代币          |     |  或addLiquidityETH   |     | 存在，不存在则创建    |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
                                                              |
                                                              v
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  Pair合约更新     |<----|  Pair合约铸造流动性  |<----| Router计算最佳添加   |
|  储备量和价格     |     |  代币给用户          |     | 数量并转移代币到Pair |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
```

## 交换代币流程

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  用户批准Router    |---->|  调用swap函数        |---->| Router计算最佳交易路 |
|  使用输入代币      |     |                      |     | 径和预期输出数量     |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
                                                              |
                                                              v
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  Pair合约更新     |<----|  Pair合约执行交换    |<----| Router将输入代币转移 |
|  储备量和价格     |     |  并转移输出代币给用户 |     | 到第一个Pair合约     |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
```

## 移除流动性流程

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  用户批准Router    |---->|  调用removeLiquidity |---->| Router将流动性代币   |
|  使用流动性代币    |     |  或removeLiquidityETH|     | 转移到Pair合约       |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
                                                              |
                                                              v
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  Pair合约更新     |<----|  Pair合约转移代币    |<----| Pair合约销毁流动性   |
|  储备量和价格     |     |  给用户              |     | 代币                 |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
```

## 闪电贷流程

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  调用者请求闪电贷  |---->|  Pair合约检查参数    |---->| Pair合约转移请求的   |
|                   |     |                      |     | 代币到调用者         |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
                                                              |
                                                              v
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  Pair合约验证     |<----|  调用者返还代币      |<----| Pair合约调用         |
|  K值并更新储备量   |     |  (包括0.3%手续费)    |     | uniswapV2Call函数    |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
```

## 价格预言机流程

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  交易或流动性事件  |---->|  _update函数被调用   |---->| 计算自上次更新以来   |
|  触发              |     |                      |     | 经过的时间           |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
                                                              |
                                                              v
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  更新blockTimestamp|<----|  更新储备量          |<----| 更新价格累积器       |
|  Last             |     |                      |     | price0CumulativeLast |
|                   |     |                      |     | price1CumulativeLast |
+-------------------+     +----------------------+     +----------------------+
```

## 交易对创建流程

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  调用createPair   |---->|  Factory验证参数     |---->| 对代币地址进行排序   |
|  函数             |     |                      |     |                      |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
                                                              |
                                                              v
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  更新Factory中的  |<----|  初始化交易对合约    |<----| 使用CREATE2创建      |
|  映射并触发事件    |     |                      |     | 交易对合约           |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
```

## 核心数据结构

### UniswapV2Pair 中的状态变量

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  uint112 reserve0 |     |  uint112 reserve1    |     | uint32 blockTimestamp|
|  代币0的储备量     |     |  代币1的储备量       |     | Last 最后更新时间戳   |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+

+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  uint price0      |     |  uint price1         |     |  uint kLast          |
|  CumulativeLast   |     |  CumulativeLast      |     |  最后的k值           |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
```

### UniswapV2Factory 中的状态变量

```
+-------------------+     +----------------------------------------------------+
|                   |     |                                                    |
|  address feeTo    |     |  mapping(address => mapping(address => address))   |
|  费用接收地址      |     |  getPair 双重映射存储交易对地址                    |
|                   |     |                                                    |
+-------------------+     +----------------------------------------------------+

+-------------------+     +----------------------+
|                   |     |                      |
|  address          |     |  address[] allPairs  |
|  feeToSetter      |     |  所有交易对数组      |
|                   |     |                      |
+-------------------+     +----------------------+
```

### UniswapV2ERC20 中的状态变量

```
+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  uint totalSupply |     |  mapping(address =>  |     | mapping(address =>   |
|  总供应量         |     |  uint) balanceOf     |     | mapping(address =>   |
|                   |     |                      |     | uint)) allowance     |
+-------------------+     +----------------------+     +----------------------+

+-------------------+     +----------------------+     +----------------------+
|                   |     |                      |     |                      |
|  bytes32          |     |  bytes32 PERMIT_     |     | mapping(address =>   |
|  DOMAIN_SEPARATOR |     |  TYPEHASH           |     | uint) nonces         |
|                   |     |                      |     |                      |
+-------------------+     +----------------------+     +----------------------+
``` 